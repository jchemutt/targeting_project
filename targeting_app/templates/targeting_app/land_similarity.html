<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% load static %}
    <title>Land Similarity</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta name="keywords" content="Land Statistics, Similarity, Suitability, Land Similarity, Land Suitability, Targeting Tool">
    <meta name="description" content="Targeting Tools is a set of tools available on Web.">
    <meta name="author" content="">
      <!-- Favicon -->
      <link rel="icon" href="{% static 'targeting_app/images/ciat-icon-48.png' %}">
    <link rel="stylesheet" href="{% static 'targeting_app/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'targeting_app/css/leaflet.css' %}">
    <link rel="stylesheet" href="{% static 'targeting_app/css/leaflet.draw.css' %}">
    <link href="{% static 'targeting_app/css/custom.css' %}" rel="stylesheet">
    <style>
         .file { margin-bottom: 5px; }
        .folder > .folder-content { display: none; margin-left: 10px; }
        .folder.expanded > .folder-content { display: block; }
        .folder-icon { cursor: pointer; }

        /* Style the folder icon */
.folder-icon {
    font-size: 14px;  /* Reduce the icon size */
    vertical-align: middle;  /* Align icon with text */
}

/* Style the folder name text */
.folder {
    font-size: 14px;  /* Reduce the text size */
}
        .btn-delete { display: inline-block; }
        .loading .spinner-border { display: inline-block; }
        #map-container { height: 300px; }
        .raster-parameters { margin-top: 10px; }
        .error { color: red; font-size: 0.9em; }
        #popup-map { height: 100%; width: 100%; }
        .legend { background: white; line-height: 18px; color: #333; padding: 6px 8px; border-radius: 4px; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
        .navbar {
            background-color: #093;
        }
        .navbar-brand img {
            height: 40px;
        }
        .navbar-nav .nav-link, .navbar-nav .dropdown-item {
            color: white !important;
        }

        .navbar .nav-link:hover, .navbar .dropdown-item:hover {
            color: #093 !important;
            background-color: #fff !important;
        }
        .navbar-nav .nav-link {
            font-size: 1.2em;
        }
        .navbar-nav .ml-3 {
            margin-left: 50px; /* Increased margin for better alignment */
        }
        .dropdown-menu {
            background-color: #093; /* Match dropdown background color with navbar */
        }
        .dropdown-item {
            color: white !important; /* Ensure dropdown items are visible */
        }
        .dropdown-menu-right {
            right: 0; /* Align the dropdown to the right */
            left: auto; /* Override the default left alignment */
        }
        .dropdown-item:hover {
            color: #093 !important;
            background-color: #fff !important;
        }

        .table-responsive {
    max-height: 800px; /* Adjust the height as needed */
    overflow-y: auto;  /* Allow vertical scroll if table overflows */
}

.table {
    width: 100%;
    table-layout: fixed; /* Ensure columns take up available space evenly */
}

.folder-content {
    display: none; /* Hide all nested folders initially */
    margin-left: 20px;
}

.folder.expanded .folder-content {
    display: block;
}

#fileList {
    max-height: 500px; /* Adjust height as necessary */
    overflow-y: auto;
}

.folder-content {
    margin-left: 10px; /* Decrease the indentation */
}

/* Style for the file names */
.file-name {
    font-size: 12px;  /* Adjust font size */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;  /* Adjust based on desired width */
    display: inline-block;
    vertical-align: middle;  /* Align with checkbox */
}

/* Custom style for checkboxes */
.custom-checkbox {
    height: 20px;  /* Adjust the height of the checkbox */
    width: 20px;   /* Adjust the width of the checkbox */
    vertical-align: middle;  /* Align checkbox vertically with text */
}

/* Adjust the height of the list items */
.file {
    height: 30px;  /* Fixed height for list items */
    display: flex;
    align-items: center;  /* Vertically align content inside the list item */
}

.small-text {
    font-size: 12px;  /* Reduce text size */
}

.table th, .table td {
    vertical-align: middle;  /* Ensure the content is vertically aligned */
    padding: 0.5rem; /* Adjust padding for better alignment */
}

/* Ensure inputs, selects, and buttons are smaller and aligned */
.small-input, .small-select {
    font-size: 12px;  /* Smaller font size */
    height: 28px;     /* Adjust height for a more compact look */
    padding: 4px 8px; /* Adjust padding for better fit */
    vertical-align: middle; /* Vertically align inputs and selects */
}

/* Ensure the buttons are horizontally aligned with inputs */
.action-buttons {
    /*display: flex;*/
    justify-content: space-between; /* Space between buttons */
    align-items: center; /* Vertically align buttons and inputs */
    gap: 5px; /* Space between buttons */
    height: 100%; /* Ensure it takes full height of the table cell */
}

/* Reduce button size and override Bootstrap styles */
.action-buttons .btn {
    padding: 3px 6px !important;  /* Smaller padding for a compact look */
    font-size: 12px !important;   /* Smaller font size for icons */
    display: inline-flex;
    align-items: center; /* Vertically center content within buttons */
    justify-content: center; /* Center content within buttons */
}

.small-text {
    font-size: 12px; /* Reduce text size for entire section */
}

.form-check-label {
    font-size: 12px;
}

input, button, label, h5 {
    font-size: 12px; /* Adjust this size as per your need */
}

/* Group background colors */
.group-1 {
    background-color: #f9f9f9;
}

.group-2 {
    background-color: #e9e9e9;
}

.group-3 {
    background-color: #d9d9d9;
}

.group-4 {
    background-color: #c9c9c9;
}

.group-5 {
    background-color: #b9b9b9;
}

/* Style for the collapse/expand button */
.collapse-btn {
    margin-right: 5px;
    padding: 0;
    font-size: 14px;
    border: none;
    background: none;
    cursor: pointer;
}

.collapse-btn:focus {
    outline: none;
}
    </style>
</head>
<body>
    {% include 'targeting_app/navbar.html' %}
    <div class="container mt-4">
        <h3>Data - Land Similarity</h3>
        <div class="row">
            <div class="col-md-5">
                <div id="fileList"></div>
            </div>
            <div class="col-md-7">
                <div class="card small-text mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Selected Data:</h5>
                        <div id="selectedFilesContainer"></div>
                    </div>
                </div>
                <div class="card small-text" id="aoiSection">
                    <div class="card-body">
                        <h5 class="card-title">Select Sample Points</h5>

                        <div class="form-check-group d-flex align-items-center">
                            <div class="form-check mr-3">
                                <input class="form-check-input" type="radio" name="aoiOption" id="aoiOptionMap" value="map" checked>
                                <label class="form-check-label" for="aoiOptionMap">Select on the Map</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="aoiOption" id="aoiOptionFile" value="file">
                                <label class="form-check-label" for="aoiOptionFile">Upload File (Points GeoJSON/CSV (Latitude,Longitude))</label>
                            </div>
                        </div>
                        
                        <!-- Map section -->
                        <div id="mapSection" class="mt-3">
                            <div id="map-container"></div>
                        </div>
                        
                        <!-- File upload section -->
                        <div id="fileUploadSection" class="mt-3" style="display: none;">
                            <label for="aoiFileUpload">Upload file (Points GeoJSON/CSV (Latitude,Longitude)):</label>
                            <input type="file" id="aoiFileUpload" name="aoiFileUpload" accept=".geojson, .csv">
                            <div id="fileError" class="error mt-2"></div>
                        </div>
                        
                        <!-- Hidden inputs for storing data -->
                        <input type="hidden" id="pointsInput" name="points" value="">
                        <input type="hidden" id="uploadedPointsInput" name="uploadedPoints" value="">
                    

                    </div>
                </div>
                <div class="card small-text">
                    <div class="card-body">
                        <form id="selectedFilesForm" method="POST" action="/api/processLandSimilarity" onsubmit="return validateForm(event)">
                            {% csrf_token %}
                            <input type="hidden" id="pointsInput" name="points" value="">
                            <div class="form-group">
                                <label for="description">
                                    Description: <span style="color: red;">*</span>
                                </label>
                                <input type="text"  id="description" name="description" class="form-control"
                                       placeholder="Enter a brief title of your analysis" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm" id="submitBtn"><i class="fas fa-play"> </i> Run Analysis</button>
                        </form>
                        <div id="resultSection" class="mt-3" style="display: none;">
                            <h4>Processing Complete</h4>
                            <a id="downloadMessLink" href="#" class="btn btn-success btn-sm" download>
                                <i class="fas fa-download"></i> Download MESS
                            </a>
                            <a id="downloadMnobisLink" href="#" class="btn btn-success btn-sm" download>
                                <i class="fas fa-download"></i> Download Mahalanobis Distance
                            </a>
                                        
                            <button id="viewMnobisMapBtn" class="btn btn-info btn-sm mt-2">
                                <i class="fas fa-map"></i> View Mahalanobis Map
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal fade small-text" id="progressModal" tabindex="-1" role="dialog" aria-labelledby="progressModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="progressModalLabel">Processing...</h5>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                    <p class="text-center mt-3">Please wait while your request is being processed.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal fade small-text" id="resultModal" tabindex="-1" role="dialog" aria-labelledby="resultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content" style="height: 80vh;">
                <div class="modal-header">
                    <h5 class="modal-title" id="resultModalLabel">Mahalanobis Map</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body p-0">
                    <div id="popup-map" style="height: 100%; width: 100%;"></div>
                </div>
                <div class="modal-footer">
                    <a id="downloadLink2" href="#" class="btn btn-primary" download><i class="fas fa-download"></i> Download Result</a>
                </div>
            </div>
        </div>
    </div>
    {% include 'targeting_app/footer.html' %}

    <script src="{% static 'targeting_app/js/jquery-3.5.1.min.js' %}"></script>
    <script src="{% static 'targeting_app/js/popper.min.js' %}"></script>
    <script src="{% static 'targeting_app/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'targeting_app/js/leaflet.js' %}"></script>
    <script src="{% static 'targeting_app/js/leaflet.draw.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
    <script src="{% static 'targeting_app/js/georaster.browser.bundle.min.js' %}"></script>
    <script src="{% static 'targeting_app/js/georaster-layer-for-leaflet.min.js' %}"></script>
    <script src="{% static 'targeting_app/js/rainbowvis.js' %}"></script>

    <script>
            document.addEventListener('DOMContentLoaded', () => {

            const aoiOptionMap = document.getElementById('aoiOptionMap');
            const aoiOptionFile = document.getElementById('aoiOptionFile');
            const mapSection = document.getElementById('mapSection');
            const fileUploadSection = document.getElementById('fileUploadSection');
            const aoiFileUpload = document.getElementById('aoiFileUpload');
            const pointsInput = document.getElementById('pointsInput');
            const uploadedPointsInput = document.getElementById('uploadedPointsInput');
            const fileError = document.getElementById('fileError');

               
              
            const fileListElement = document.getElementById('fileList');
            const selectedFilesForm = document.getElementById('selectedFilesForm');
            const selectedFilesContainer = document.getElementById('selectedFilesContainer');
            let map;
            let popupMap; 
            let resultUrl = "";
            let messResultUrl = "";
            let mnobisResultUrl = "";
            let drawnItems = new L.FeatureGroup();

            // Leaflet map setup
            function setupMap() {
                map = L.map('map-container').setView([0, 0], 1); // Default view, will be updated dynamically

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                map.addLayer(drawnItems); // Add drawn items layer to the map

                // Initialize Leaflet Draw
                const drawOptions = {
                    position: 'topleft',
                    draw: {
                        marker: true,
                        polygon: false,
                        polyline: false,
                        circle: false,
                        rectangle: false,
                        circlemarker: false
                    },
                    edit: {
                        featureGroup: drawnItems,
                        remove: true // Allow removing drawn items
                    }
                };
                const drawControl = new L.Control.Draw(drawOptions);
                map.addControl(drawControl);

                // Event listener for marker drawn
                map.on(L.Draw.Event.CREATED, function (event) {
                    const layer = event.layer;
                    drawnItems.addLayer(layer); // Add new drawn layer
                    updatePointsInput();
                });

                // Event listener for marker deleted
                map.on(L.Draw.Event.DELETED, function () {
                    updatePointsInput();
                });
            }

            function updatePointsInput() {
                const points = [];
                drawnItems.eachLayer(function (layer) {
                    if (layer instanceof L.Marker) {
                        const latLng = layer.getLatLng();
                        points.push([latLng.lng, latLng.lat]); // Capture coordinates in [longitude, latitude] format
                    }
                });
                pointsInput.value = JSON.stringify(points);
            }

            // Event listeners for radio buttons
    aoiOptionMap.addEventListener('change', () => {
        if (aoiOptionMap.checked) {
            mapSection.style.display = 'block'; // Show the map section
            fileUploadSection.style.display = 'none'; // Hide the file upload section
            aoiFileUpload.value = ''; // Clear file input
            uploadedPointsInput.value = ''; // Clear uploaded points
            fileError.textContent = ''; // Clear any error message
        }
    });

    aoiOptionFile.addEventListener('change', () => {
        if (aoiOptionFile.checked) {
            mapSection.style.display = 'none'; // Hide the map section
            fileUploadSection.style.display = 'block'; // Show the file upload section
            drawnItems.clearLayers(); // Clear map markers
            pointsInput.value = ''; // Clear map points
        }
    });

    // File processing
    aoiFileUpload.addEventListener('change', () => {
        const file = aoiFileUpload.files[0];
        if (!file) {
            fileError.textContent = 'Please select a file to upload.';
            return;
        }

        const reader = new FileReader();
        const fileExtension = file.name.split('.').pop().toLowerCase();

        if (fileExtension === 'geojson') {
            reader.onload = (e) => processGeoJSON(e.target.result);
        } else if (fileExtension === 'csv') {
            reader.onload = (e) => processCSV(e.target.result);
        } else {
            fileError.textContent = 'Invalid file format. Please upload a GeoJSON or CSV file.';
            return;
        }

        reader.readAsText(file);
    });


    function processGeoJSON(content) {
        try {
            const geoJSON = JSON.parse(content);
            const points = [];

            geoJSON.features.forEach((feature) => {
                if (feature.geometry.type === 'Point' && feature.geometry.coordinates.length === 2) {
                    const [lng, lat] = feature.geometry.coordinates;
                    points.push([lng, lat]);
                }
            });

            if (points.length === 0) {
                fileError.textContent = 'No valid points found in the GeoJSON file.';
                return;
            }

            uploadedPointsInput.value = JSON.stringify(points);
            fileError.textContent = '';
           
        } catch (error) {
            fileError.textContent = 'Error processing GeoJSON file.';
            console.error(error);
        }
    }

    function processCSV(content) {
        try {
            const rows = content.split('\n');
            const header = rows[0].split(',');
            const latIndex = header.findIndex((col) => col.trim().toLowerCase() === 'latitude');
            const lngIndex = header.findIndex((col) => col.trim().toLowerCase() === 'longitude');

            if (latIndex === -1 || lngIndex === -1) {
                fileError.textContent = 'CSV file must have "Latitude" and "Longitude" columns.';
                return;
            }

            const points = [];
            rows.slice(1).forEach((row) => {
                const columns = row.split(',');
                const lat = parseFloat(columns[latIndex]);
                const lng = parseFloat(columns[lngIndex]);

                if (!isNaN(lat) && !isNaN(lng)) {
                    points.push([lng, lat]);
                }
            });

            if (points.length === 0) {
                fileError.textContent = 'No valid points found in the CSV file.';
                return;
            }

            uploadedPointsInput.value = JSON.stringify(points);
            fileError.textContent = '';
           
        } catch (error) {
            fileError.textContent = 'Error processing CSV file.';
            console.error(error);
        }
    }



            // Function to fetch directory contents from Django view
            async function fetchDirectoryContents(directoryPath) {
                try {
                    const response = await fetch(`/api/getDirectoryContents?path=${encodeURIComponent(directoryPath)}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch directory contents');
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching directory contents:', error);
                    alert('Failed to load directory contents. Please try again later.');
                    return [];
                }
            }

            // Function to fetch folder configurations from Django view
            async function fetchFolderConfigurations(folderName) {
                try {
                    const response = await fetch(`/api/getFolderConfigurations?folder=${encodeURIComponent(folderName)}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch folder configurations');
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Error fetching folder configurations:', error);
                    alert('Failed to load folder configurations. Please try again later.');
                    return { center: [0, 0], zoom: 2 }; // Default to world view
                }
            }

            // Function to update map view based on folder configurations
            async function updateMapView(folderName) {
                const { center, zoom } = await fetchFolderConfigurations(folderName);
                map.setView(center, zoom);
            }

            // Function to sanitize file path for valid CSS selector
            function sanitizeFilePath(filePath) {
                return filePath.replace(/[^a-zA-Z0-9]/g, '_');
            }

            // Function to display directory contents
            async function displayDirectoryContents(directoryContents, parentElement, directoryPath) {
                const ul = document.createElement('ul');
                ul.classList.add('list-group');

                directoryContents.forEach(item => {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item');

                    if (item.type === 'directory') {
                        li.classList.add('folder');
                        li.innerHTML = `<i class="fas fa-caret-right folder-icon mr-2"></i><i class="fas fa-folder mr-2"></i>${item.name}`;
                        li.style.cursor = 'pointer';
                        li.addEventListener('click', async (event) => {
                            event.stopPropagation();
                            if (!li.dataset.loaded) {
                                const subDirectoryContents = await fetchDirectoryContents(`${directoryPath}/${item.name}`);
                                displayDirectoryContents(subDirectoryContents, li.querySelector('.folder-content'), `${directoryPath}/${item.name}`);
                                li.dataset.loaded = true;
                            }
                            li.classList.toggle('expanded');
                            const folderContent = li.querySelector('.folder-content');
                            folderContent.style.display = folderContent.style.display === 'block' ? 'none' : 'block';
                            const folderIcon = li.querySelector('.folder-icon');
                            folderIcon.classList.toggle('fa-caret-right');
                            folderIcon.classList.toggle('fa-caret-down');
                            // Update map view when folder is clicked
                            updateMapView(item.name);
                        });
                        const folderContent = document.createElement('div');
                        folderContent.classList.add('folder-content');
                        li.appendChild(folderContent);
                    } else if (item.type === 'file') {
                        li.classList.add('file');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = `${directoryPath}/${item.name}`;
                        checkbox.classList.add('mr-2');
                        checkbox.addEventListener('click', (event) => {
                            event.stopPropagation(); // Prevent propagation to parent li
                        });
                        checkbox.addEventListener('change', () => {
                            if (checkbox.checked) {
                                addSelectedFile(checkbox.value, item.name);
                            } else {
                                removeSelectedFile(checkbox.value);
                            }
                        });
                        const label = document.createElement('label');
                        label.textContent = item.name;
                        li.appendChild(checkbox);
                        li.appendChild(label);
                    }

                    ul.appendChild(li);
                });

                parentElement.appendChild(ul);
            }

            // Function to add selected file to the selected files container
            function addSelectedFile(filePath, fileName) {
                const sanitizedFilePath = sanitizeFilePath(filePath);
                const selectedFileItem = document.createElement('div');
                selectedFileItem.classList.add('mb-2', 'selected-file-item', 'd-flex', 'align-items-center');
                selectedFileItem.innerHTML = `
                    <span class="flex-grow-1">${fileName}</span>
                    <button type="button" class="btn btn-sm btn-danger ml-2 btn-delete">
                        <i class="fas fa-trash"></i>
                    </button>
                    <input type="hidden" name="selectedFiles[]" value="${filePath}">
                `;
                const deleteButton = selectedFileItem.querySelector('.btn-delete');
                deleteButton.addEventListener('click', () => {
                    selectedFileItem.remove();
                    const correspondingCheckbox = fileListElement.querySelector(`input[type="checkbox"][value="${filePath}"]`);
                    if (correspondingCheckbox) {
                        correspondingCheckbox.checked = false;
                    }
                });
                selectedFilesContainer.appendChild(selectedFileItem);
            }

            // Function to remove selected file from the selected files container
            function removeSelectedFile(filePath) {
                const selectedFileItems = selectedFilesContainer.querySelectorAll('.selected-file-item');
                selectedFileItems.forEach(item => {
                    const input = item.querySelector(`input[type="hidden"][value="${filePath}"]`);
                    if (input) {
                        item.remove();
                    }
                });
            }

            // Validate form before submission
            function validateForm(event) {
                event.preventDefault(); // Prevent the form from submitting
                const descriptionInput = document.getElementById('description');
                const descriptionValue = descriptionInput.value.trim();

                    if (!descriptionValue) {
                        alert('Description is required.');
                        descriptionInput.focus();
                        return false;
                    }

                const selectedFiles = selectedFilesContainer.querySelectorAll('.selected-file-item');
                if (selectedFiles.length < 2) {
                    alert('Please select at least two files.');
                    return false;
                }

                const aoiOptionMap = document.getElementById('aoiOptionMap').checked; // Check if "Select on the Map" is selected
                const aoiOptionFile = document.getElementById('aoiOptionFile').checked; // Check if "Upload File" is selected

                let points = [];
                if (aoiOptionMap) {
                    // Capture points from the map
                    points = JSON.parse(pointsInput.value || '[]');
                    if (points.length === 0) {
                        alert('Please select at least one point on the map.');
                        return false;
                    }
                } else if (aoiOptionFile) {
                    // Capture points from the map
                    points = JSON.parse(uploadedPointsInput.value || '[]');
                    if (points.length === 0) {
                        alert('Please upload points data either in Geojson or csv format.');
                        return false;
                    }

                }


                const formData = {
                    selectedFiles: Array.from(selectedFiles).map(item => item.querySelector(`input[type="hidden"]`).value),
                    points: pointsInput.value||uploadedPointsInput.value, 
                    description: descriptionValue,
                };

                //console.error('FormData:', formData);

                // Show progress modal
                $('#progressModal').modal('show');

                

                fetch('/api/processLandSimilarity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    $('#progressModal').modal('hide');
                    if (data.status === 'success') {
                        resultUrl = data.result_url;
                        console.error('resultUrl:', resultUrl);
                        messResultUrl = resultUrl.mess;
                         mnobisResultUrl = resultUrl.mnobis;
                        $('#downloadMessLink').attr('href', resultUrl.mess);
                        $('#downloadMnobisLink').attr('href', resultUrl.mnobis);
                        $('#downloadLink2').attr('href', resultUrl.mnobis);
                        $('#resultSection').show();
                        // Scroll the page to the result section
                      $('html, body').animate({
                    scrollTop: $('#resultSection').offset().top
                }, 500);
                
                    } else {


                        alert(`Error: ${data.message}`);
                    }
                })
                .catch(error => {
                    $('#progressModal').modal('hide');
                    console.error('Error:', error);
                    alert('An error occurred while processing the form.');
                });

                return false;
            }

            document.getElementById('submitBtn').addEventListener('click', validateForm);

            // Fetch and display the root directory contents on page load
            fetchDirectoryContents('/')
                .then(directoryContents => displayDirectoryContents(directoryContents, fileListElement, ''))
                .catch(error => console.error('Error displaying root directory contents:', error));

            // Initialize Leaflet map
            setupMap();
          

          


            document.getElementById('viewMnobisMapBtn').addEventListener('click', function () {
                $('#resultModal').modal('show');
                displayResultOnMap(mnobisResultUrl);
            });

            

            function displayResultOnMap(url) {
    // Remove any existing map instance
    if (popupMap) {
        
        popupMap.remove(); // Destroy the existing map instance
      
    }

    // Show modal and initialize map
    $('#resultModal').on('shown.bs.modal', async function () {
    popupMap = L.map('popup-map').setView([0, 0], 5);

    // Add base map layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
    }).addTo(popupMap);

    try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const georaster = await parseGeoraster(arrayBuffer);

        console.log("Georaster object:", georaster);

        const nodataValue = georaster.nodataValue || null;
        const minValue = georaster.mins[0]; // Get minimum value from GeoRaster object
        const maxValue = georaster.maxs[0]; // Get maximum value from GeoRaster object

        console.log("Min value:", minValue, "Max value:", maxValue);

        if (minValue === undefined || maxValue === undefined || minValue === maxValue) {
            alert('Error: Raster contains no valid data or uniform values.');
            return;
        }

        // Define the colormap using Chroma.js
        const colormap = chroma
            .scale(['#440154', '#31688e', '#35b779', '#fde725']) // Viridis-like colormap
            .domain([minValue, maxValue]);

        // Function to map pixel values to colors dynamically
        const pixelValuesToColorFn = values => {
            const value = values[0];
            if (value === nodataValue || isNaN(value)) return null;
            return colormap(value).hex();
        };

        const layer = new GeoRasterLayer({
            georaster,
            opacity: 0.7,
            pixelValuesToColorFn,
            resolution: 256, // Adjust resolution for performance
        });

        layer.addTo(popupMap);

        // Fit map bounds to layer
        const bounds = layer.getBounds();
        popupMap.fitBounds(bounds);

        // Add a Continuous Color Legend
        const legend = L.control({ position: 'bottomright' });

        legend.onAdd = function () {
            const div = L.DomUtil.create('div', 'info legend');

            // Create a gradient color bar
            const gradientColors = colormap.colors(100).join(","); // Generate 100 color stops
            div.innerHTML = `
                <div><strong>Legend</strong></div>
                <div style="width: 200px; height: 15px; background: linear-gradient(to right, ${gradientColors});"></div>
                <div style="display: flex; justify-content: space-between;">
                    <span>${minValue.toFixed(2)}</span>
                    <span>${maxValue.toFixed(2)}</span>
                </div>
            `;

            return div;
        };

        legend.addTo(popupMap);
    } catch (error) {
        console.error('Error loading raster:', error);
        alert('An error occurred while loading the raster.');
    }
});

}








        });
    </script>
</body>
</html>